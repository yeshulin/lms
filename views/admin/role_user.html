<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Data-Table 表格</title>
    <link rel="stylesheet" href="/static/vipadmin/frame/layui/css/layui.css">
    <!--<link rel="stylesheet" href="/static/vipadmin/css/jquery.dataTables.min.css">-->
    <link rel="stylesheet" href="/static/vipadmin/css/style.css">
    <link rel="icon" href="/static/vipadmin/image/code.png">
</head>
<body class="body">

<a class="refresh c-24" href="javascript:refresh_iframe();"><i class="Hui-iconfont Hui-iconfont-huanyipi f-16"></i>刷新</a>
<fieldset class="layui-elem-field layui-field-title" style="margin-top:20px;">
    <legend>
        <span class="layui-breadcrumb">
            <a href="/admin" target="_top">首页</a><a href="/admin/role">角色列表</a>
			<a><cite>{{.role.Name}}</cite></a>
        </span>
    </legend>
</fieldset>

<form class="layui-form" id="user-form">
	 <input type="hidden" name="role_id" value="{{.role.Id}}">
     <div class="layui-inline">
      <label class="layui-form-label">用户名</label>
      <div class="layui-input-inline">
        <select name="user_id" lay-verify="required" lay-search="">
          <option value="">搜索选择</option>
		{{range $key,$value := .users}}
          <option value="{{$value.Id}}">{{$value.Username}}</option>
		{{end}}
        </select>
      </div>
    </div>
  </div>
	<div class="layui-form-item" style="margin-top:10px;">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit="" name="submit" value="添加用户" lay-filter="demo1">添加用户</button>
        </div>
    </div>
</form>	

<table id="dateTable" class="layui-table">
    <thead>
    <tr>
        <th><input type="checkbox" class="my-checkbox" /></th>
        <th>用户名</th>
        <th>真实姓名</th>
		<th>角色ID</th>
        <th>角色名</th>
        <th>操作</th>
    </tr>
    </thead>
   
</table>

<script type="text/javascript" src="/static/vipadmin/frame/layui/layui.js"></script>
<!-- jQuery -->
<script type="text/javascript" charset="utf8" src="/static/vipadmin/js/jquery.js"></script>
<script type="text/javascript" src="/static/vipadmin/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="/static/vipadmin/js/table-tool.js"></script>
<script src="/static/vipadmin/js/extend.js" charset="utf-8"></script>
<script type="text/javascript">
    layui.use(['element','form'], function(){
        var $ = layui.jquery,element = layui.element,layer = layui.layer;
		var form = layui.form();

        // 初始化表格
       /* $('#dateTable').DataTable({
            "dom": '<"top">rt<"bottom"flp><"clear">',
            "autoWidth": false,                     // 自适应宽度
            "stateSave": true,                      // 刷新后保存页数
            "order": [[ 1, "desc" ]],               // 排序
            "searching": false,                     // 本地搜索
            "info": true,                           // 控制是否显示表格左下角的信息
            "stripeClasses": ["odd", "even"],       // 为奇偶行加上样式，兼容不支持CSS伪类的场合
            "aoColumnDefs": [{                      // 指定列不参与排序
                "orderable": false,
                "aTargets": [0,7]                   // 对应你的表格的列数
            }],
            "pagingType": "simple_numbers",         // 分页样式 simple,simple_numbers,full,full_numbers
            "language": {                           // 国际化
                "url":'language.json'
            }
        });
		*/
		var dataTable = $('#dateTable').DataTable( {
                  autoWidth: false,  //禁用自动调整列宽
                  stripeClasses: ["odd", "even"],  //为奇偶行加上样式，兼容不支持CSS伪类的场合
                  processing: true,  //隐藏加载提示,自行处理
                  serverSide: true,  //启用服务器端分页
                  //searching: false,  //禁用原生搜索
                  orderMulti: false,  //启用多列排序
                  order: [
                      [0,'desc']
                  ],  //取消默认排序查询,否则复选框一列会出现小箭头
                  renderer: "bootstrap",  //渲染样式：Bootstrap和jquery-ui
                  pagingType: "full_numbers",  //分页样式：simple,simple_numbers,full,full_numbers
                  "columnDefs": [ {
                      "targets": 5,
                      "defaultContent": '<button class="layui-btn layui-btn-small layui-btn-danger delete">删除</button>'
                  } ],
                  ajax: function (data, callback, settings) {
				
                      //封装请求参数
                      var param = {};
                      var orderColumnNum = data.order[0]['column'];
                      param.sortColumn = data.columns[orderColumnNum].data;
                      //param.order = data.order[0]['dir'];
                      param.limit = data.length;//页面显示记录条数，在页面显示每页显示多少项的时候
                      param.start = data.start;//开始的记录序号
                      param.page = (data.start / data.length)+1;//当前页码
                      param.search = data['search']['value'];
					  param.id = {{.role.Id}};
					  console.log(param)
                      //ajax请求数据
                      $.ajax({
                          type: "GET",
                          url: "/admin/role/userfind",
                          cache: false,  //禁用缓存
                          data: param,  //传入组装的参数
                          dataType: "json",
                          success: function (result) {
							
                              console.log(result);
                              //setTimeout仅为测试延迟效果
							//console.log(result);
                              setTimeout(function () {
                                  //封装返回数据
                                  var returnData = {};
                                  //returnData.draw = data.draw;//这里直接自行返回了draw计数器,应该由后台返回
                                  returnData.recordsTotal = result.total;//返回数据全部记录
                                  returnData.recordsFiltered = result.total;//后台不实现过滤功能，每次查询均视作全部结果
                                  returnData.data = result.data;//返回的数据列表
                                  //console.log(returnData);
                                  //调用DataTables提供的callback方法，代表数据已封装完成并传回DataTables进行渲染
                                  //此时的数据需确保正确无误，异常判断应在执行此回调前自行处理完毕
                                  callback(returnData);
                              }, 200);
                          }
                      });
                  },

                  //列表表头字段
                  columns: [
	                { data: 'Id' },
			        { data: 'Username' },
			        { data: 'Realname' },
			        { data: 'Role_id' },
			        { data: 'Rolename' }
                  ],
                  "language": {
                      "processing": "加载中...",
                      "lengthMenu": "显示 _MENU_ 条结果",
                      "zeroRecords": "没有匹配结果",
                      "info": "显示第 _START_ 至 _END_ 条结果，共 _TOTAL_ 条",
                      "infoEmpty": "显示第 0 至 0 条结果，共 0 条",
                      "infoFiltered": "(由 _MAX_ 项结果过滤)",
                      "infoPostFix": "",
                      "search": "搜索:",
                      "searchPlaceholder": "搜索...",
                      "url": "",
                      "emptyTable": "表中数据为空",
                      "loadingRecords": "载入中...",
                      "infoThousands": ",",
                      "paginate": {
                          "first": "首页",
                          "previous": "上页",
                          "next": "下页",
                          "last": "末页"
                      },
                      "aria": {
                          paginate: {
                              first: '首页',
                              previous: '上页',
                              next: '下页',
                              last: '末页'
                          },
                          "sortAscending": ": 以升序排列此列",
                          "sortDescending": ": 以降序排列此列"
                      },
                      "decimal": "-",
                      "thousands": "."
                  }

              });
		
        // 例:获取ids
        $(document).on('click','#btn-delete-all', function(){
            // getIds(table对象,获取input为id的属性)
            var list = getIds($('#dateTable'),'data-id');
            if(list == null || list == ''){
                layer.msg('未选择');
            }else{
                layer.msg(list);
            }
        });
		
         $('#dateTable tbody').on( 'click','.delete',function () {

            var data = dataTable.row( $(this).parents('tr') ).data();
			//console.log(data);
            layer.confirm('你确定要删除id：'+ data.Id +' 吗', {
                time: 0 //不自动关闭
                ,btn: ['确认', '取消']
                ,yes: function(index){
                    layer.close(index);
                    layer.msg('正在删除', {
                        icon: 16,
                        btnAlign: 'c',
                        btn: ['确认'],
                        time: 1000
                    });
					$.post("/admin/role/deluser",{id:data.Id},function(data){
						if(data.code==1){
							window.location = "/admin/role/user?id="+{{.role.Id}};
						}else{
							layer.msg('删除信息失败！');
						}
					},"json")
                    
                }
            });
        } );
	
		//监听提交
        form.on('submit(demo1)', function(data){
            layer.alert(JSON.stringify(data.field), {
                title: '最终的提交信息'
            });

			//console.log(data.field);
			//return false;
			$.post("/admin/role/adduser",data.field,function(data){
				console.log(data);
				if(data.code==1){
					 layer.msg('添加用户成功，正为你跳转！', {
		                icon: 16
		                ,shade: 0.01
		            });
					window.location="/admin/role/user?id="+{{.role.Id}};
				}else{
					layer.msg('添加用户失败！');
				}
			},"json")
			return false;
        });
    });
	 
</script>
</body>
</html>